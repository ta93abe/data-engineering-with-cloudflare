name: Elementary Data Quality Monitor

on:
  # ÊâãÂãïÂÆüË°å„ÅÆ„ÅøÔºàÊú¨Áï™Áí∞Â¢ÉÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅÔºâ
  workflow_dispatch:

jobs:
  dbt-test-and-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install dbt-duckdb==1.7.2
          pip install elementary-data[duckdb]==0.15.1

      - name: Install dbt packages
        working-directory: dbt
        run: dbt deps

      - name: Run dbt models
        working-directory: dbt
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Running dbt models..."
          dbt run --target prod --profiles-dir .

      - name: Run dbt tests
        working-directory: dbt
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Running dbt tests..."
          dbt test --target prod --profiles-dir .
        continue-on-error: true

      - name: Run Elementary models
        working-directory: dbt
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "Running Elementary models for metadata collection..."
          dbt run --select elementary --target prod --profiles-dir .

      - name: Generate Elementary Report
        working-directory: dbt
        run: |
          echo "Generating Elementary HTML report..."
          edr report \
            --project-dir . \
            --profiles-dir . \
            --profile-target prod \
            --file-path elementary_report.html

      - name: Upload Elementary Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: elementary-report-${{ github.run_number }}
          path: dbt/elementary_report.html
          retention-days: 30

      - name: Run Elementary Monitor with Slack notification
        if: always()
        working-directory: dbt
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "Sending Elementary monitor results to Slack..."
            edr monitor \
              --project-dir . \
              --profiles-dir . \
              --profile-target prod \
              --slack-webhook "$SLACK_WEBHOOK_URL" \
              --slack-channel-name data-quality \
              --timezone UTC
          else
            echo "SLACK_WEBHOOK_URL not set, skipping Slack notification"
          fi

      - name: Deploy Report to Cloudflare Pages
        if: github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dbt/elementary_output --project-name=data-quality-dashboard --branch=main
        # Ê≥®ÊÑè: „Éá„Éó„É≠„Ç§Âæå„ÄÅCloudflare Access„Åß‰øùË≠∑„Åô„Çã„Åì„Å®„ÇíÊé®Â•®
        # Ë®≠ÂÆöÊâãÈ†Ü: docs/cloudflare-security-zerotrust.md ÂèÇÁÖß

      - name: Comment PR with Report Link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runNumber = context.runNumber;
            const comment = `## üìä Elementary Data Quality Report

            Elementary has analyzed your dbt models and tests.

            **Artifacts:**
            - [View Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Summary:**
            - Run Number: ${runNumber}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref }}

            Download the artifact to view the full HTML report.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Notify on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "‚ùå Elementary Data Quality Monitor Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Elementary Monitor Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
