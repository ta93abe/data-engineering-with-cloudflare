name: GitHub Data Fetch

on:
  # æ¯æ—¥åˆå‰2æ™‚(UTC)ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      owner:
        description: 'GitHub owner/organization (ç©ºæ¬„ã§å…¨ãƒªãƒã‚¸ãƒˆãƒª)'
        required: false
        default: ''
      repos:
        description: 'ãƒªãƒã‚¸ãƒˆãƒªå(ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ç©ºæ¬„ã§å…¨ãƒªãƒã‚¸ãƒˆãƒª)'
        required: false
        default: ''

jobs:
  fetch-github-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync
          # dlt GitHub extras ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          uv pip install 'dlt[filesystem,github]'

      - name: Run GitHub data pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          GITHUB_OWNER: ${{ github.event.inputs.owner }}
          GITHUB_REPOS: ${{ github.event.inputs.repos }}
        run: |
          echo "ğŸ™ GitHub ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’é–‹å§‹..."
          echo "================================================"

          if [ -n "$GITHUB_OWNER" ]; then
            echo "ğŸ“Œ å¯¾è±¡ã‚ªãƒ¼ãƒŠãƒ¼: $GITHUB_OWNER"
          else
            echo "ğŸ“Œ å¯¾è±¡: èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒªãƒã‚¸ãƒˆãƒª"
          fi

          if [ -n "$GITHUB_REPOS" ]; then
            echo "ğŸ“Œ å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: $GITHUB_REPOS"
          else
            echo "ğŸ“Œ å–å¾—ç¯„å›²: å…¨ãƒªãƒã‚¸ãƒˆãƒª"
          fi

          echo "================================================"

          uv run python scripts/github_pipeline.py

      - name: Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âœ… GitHub ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆåŠŸ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… GitHub Data Fetch - Success"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\næˆåŠŸ"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡Œæ™‚åˆ»:*\n${{ github.event.repository.updated_at }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒˆãƒªã‚¬ãƒ¼:*\n${{ github.event_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "GitHubã®å…¨ãƒªãƒã‚¸ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ãŒR2 Bronze Layerã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’è¡¨ç¤º"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âŒ GitHub ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ GitHub Data Fetch - Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nå¤±æ•—"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡Œæ™‚åˆ»:*\n${{ github.event.repository.updated_at }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒˆãƒªã‚¬ãƒ¼:*\n${{ github.event_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âš ï¸ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      - name: Upload pipeline logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-pipeline-logs-${{ github.run_id }}
          path: |
            .dlt/
            *.log
          retention-days: 7
          if-no-files-found: ignore
